# news_digest.py
import os
import asyncio
import logging
from datetime import datetime
import pytz

# å¤ç”¨åŸæœ‰é¡¹ç›®çš„æ¨¡å— (å‡è®¾é¡¹ç›®ç»“æ„å¦‚ä½ æä¾›çš„æ–‡ä»¶åˆ—è¡¨æ‰€ç¤º)
from config import Config
from search_service import SearchService
from analyzer import GeminiAnalyzer  # æˆ–åŸé¡¹ç›®ä¸­çš„ AI åˆ†æç±»
from notification import EmailNotifier # å‡è®¾é€šçŸ¥æ¨¡å—æœ‰åä¸º EmailNotifier çš„ç±»æˆ–å‘é€å‡½æ•°

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

async def generate_morning_brief():
    logger.info("å¼€å§‹ç”Ÿæˆæ¯æ—¥å¸‚åœºæ™¨æŠ¥...")
    
    # 1. åˆå§‹åŒ–æœåŠ¡
    cfg = Config()
    search_service = SearchService(cfg)
    llm_analyzer = GeminiAnalyzer(cfg) # å‡è®¾è¿™æ˜¯åˆå§‹åŒ–æ–¹å¼
    
    # 2. æ‰§è¡Œå¹¿åº¦æœç´¢ (é’ˆå¯¹è¿‡å»24å°æ—¶)
    # æœç´¢è¯æ—¨åœ¨è¦†ç›–æ­£è§„æ–°é—»å’Œå¸‚åœºä¼ é—»
    search_queries = [
        "è¿‡å»24å°æ—¶ä¸­å›½è¯åˆ¸å¸‚åœºé‡å¤§åˆ©å¥½åˆ©ç©ºæ–°é—»",
        "latest Chinese stock market news and rumors last 24 hours",
        "Aè‚¡ æ¸¯è‚¡ å¸‚åœºä¼ é—» å°ä½œæ–‡ æœ€æ–°",
        "æƒå¨è´¢ç»åª’ä½“å¤´æ¡ 24å°æ—¶å†… æ–°æµªè´¢ç» ä¸œæ–¹è´¢å¯Œ è´¢è”ç¤¾",
        "China stock market regulation updates and insider rumors"
    ]
    
    logger.info("æ­£åœ¨æœç´¢å…¨ç½‘æ–°é—»...")
    # å‡è®¾ search_service æœ‰ä¸€ä¸ªç»¼åˆæœç´¢æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé€šå¸¸æ˜¯ search(query)
    # è¿™é‡Œæˆ‘ä»¬èšåˆæœç´¢ç»“æœ
    raw_context = ""
    for query in search_queries:
        results = await search_service.search(query) # æ ¹æ®å®é™…ä»£ç è°ƒæ•´è°ƒç”¨æ–¹å¼
        raw_context += f"\nSearch Query: {query}\nResults: {results}\n"

    # 3. æ„å»º Prompt (æ ¸å¿ƒï¼šæ ¼æ …ä¸»ä¹‰é£æ ¼ HTML + åˆ†ç±»ç­›é€‰)
    current_date = datetime.now(pytz.timezone('Asia/Shanghai')).strftime('%Y-%m-%d')
    
    prompt = f"""
    You are a professional financial editor specializing in the Chinese stock market. 
    Analyze the following raw search results from the past 24 hours:
    {raw_context}

    **Task:**
    Create a "Morning Market Brief" for {current_date}. 
    Classify content into two strict categories:
    1. **Market Facts (Reliable News):** Select the 20 most important, confirmed news items from authoritative sources (Gov, Reuters, Sina Finance, etc.). No speculation.
    2. **Market Rumors (The Grapevine):** Select the 20 hottest unconfirmed market rumors ("å°ä½œæ–‡", speculation, buzz) currently discussed in the community.

    **Requirements:**
    - **Language:** Chinese (Simplified).
    - **Format:** Output PURE HTML code. No markdown code blocks (```html), just the raw HTML string.
    - **Style:** "Swiss Style" (International Typographic Style). Minimalist, clean, strictly aligned, sans-serif, high contrast.
    - **Content:** ONE sentence per item. Numbered lists.
    
    **HTML Template Structure to fill:**
    Use an internal CSS within the HTML.
    - Font: Helvetica, Arial, sans-serif.
    - Layout: A clean container (max-width 600px).
    - Header: Big, bold date and title "{current_date} å¸‚åœºæ™¨æŠ¥".
    - Section 1: "ğŸ›ï¸ å¸‚åœºè¦é—» (Facts)" - distinct header style.
    - Section 2: "ğŸ—£ï¸ å¸‚åœºä¼ é—» (Rumors)" - distinct header style (maybe different accent color).
    - List Items: Cleanly spaced, clear numbering.
    - Footer: "Generated by Gemini AI".

    Generate the HTML now.
    """

    logger.info("æ­£åœ¨é€šè¿‡ LLM ç”Ÿæˆåˆ†ææŠ¥å‘Š...")
    # è°ƒç”¨ LLM
    html_content = await llm_analyzer.chat(prompt) # å‡è®¾è¿™æ˜¯è°ƒç”¨ LLM çš„æ–¹æ³•

    # æ¸…ç†å¯èƒ½å­˜åœ¨çš„ Markdown æ ‡è®° (ä»¥é˜²ä¸‡ä¸€)
    html_content = html_content.replace("```html", "").replace("```", "").strip()

    # 4. å‘é€é‚®ä»¶
    logger.info("æ­£åœ¨å‘é€é‚®ä»¶...")
    subject = f"ã€å¸‚åœºæ™¨æŠ¥ã€‘{current_date} Aè‚¡/æ¸¯è‚¡ 20æ¡è¦é—»+20æ¡ä¼ é—»"
    
    # å‡è®¾ notification.py é‡Œæœ‰å‘é€é‚®ä»¶çš„é€»è¾‘
    # å¦‚æœåŸé€»è¾‘è€¦åˆåº¦é«˜ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨åŸé¡¹ç›®çš„é‚®ä»¶é…ç½®å‘é€
    try:
        # è¿™é‡Œéœ€è¦æ ¹æ® notification.py çš„å®é™…ä»£ç è°ƒæ•´
        # å‡è®¾å®ƒæ˜¯åŸºäºç¯å¢ƒå˜é‡é…ç½®çš„
        notifier = EmailNotifier(cfg)
        await notifier.send(subject, html_content, mime_type="html") 
        logger.info("é‚®ä»¶å‘é€æˆåŠŸï¼")
    except Exception as e:
        logger.error(f"é‚®ä»¶å‘é€å¤±è´¥: {e}")
        # å¦‚æœåŸæ¥çš„ç±»å¾ˆéš¾è°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œå†™ä¸€ä¸ªç®€å•çš„ SMTP å‘é€é€»è¾‘ä½œä¸ºå¤‡é€‰

if __name__ == "__main__":
    asyncio.run(generate_morning_brief())
